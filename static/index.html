# ä¿®æ­£å¾Œçš„ HTML ä»£ç¢¼
html_code = '''<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>è³‡æ–™æŸ¥è©¢èˆ‡ç®¡ç†</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { 
      font-family: 'Segoe UI', system-ui, sans-serif; 
      height: 100vh;
      overflow: hidden;
      background: #f5f5f5;
      touch-action: manipulation;
    }
    
    .container {
      display: flex;
      height: 100vh;
      position: relative;
    }
    
    /* å·¦å´ï¼šæœå°‹ä»‹é¢ */
    .left-panel {
      flex: 1;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      padding: 40px;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      align-items: center;
      -webkit-overflow-scrolling: touch;
    }
    
    .search-container {
      background: white;
      border-radius: 20px;
      padding: 40px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
      width: 100%;
      max-width: 1350px;
      animation: slideIn 0.5s ease-out;
    }
    
    @keyframes slideIn {
      from { opacity: 0; transform: translateY(-30px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    h1 {
      color: #333;
      margin-bottom: 10px;
      font-size: 32px;
      text-align: center;
    }
    
    .subtitle {
      color: #666;
      text-align: center;
      margin-bottom: 30px;
      font-size: 16px;
    }
    
    .input-group {
      margin-bottom: 25px;
    }
    
    label {
      display: block;
      margin-bottom: 8px;
      color: #555;
      font-weight: 600;
      font-size: 15px;
    }
    
    input[type="text"] {
      width: 100%;
      padding: 18px;
      border: 2px solid #e0e0e0;
      border-radius: 12px;
      font-size: 18px;
      transition: all 0.3s;
      background: #f8f9fa;
      -webkit-appearance: none;
    }
    
    input[type="text"]:focus {
      outline: none;
      border-color: #667eea;
      background: white;
      box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.1);
    }
    
    input[type="text"].error {
      border-color: #f44336;
      background: #ffebee;
    }
    
    .error-hint {
      color: #f44336;
      font-size: 13px;
      margin-top: 5px;
      display: none;
    }
    
    .error-hint.show {
      display: block;
    }
    
    button {
      width: 100%;
      padding: 18px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      border-radius: 12px;
      font-size: 18px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
      margin-bottom: 25px;
      position: relative;
      overflow: hidden;
      -webkit-tap-highlight-color: transparent;
      touch-action: manipulation;
    }
    
    button:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 10px 25px rgba(102, 126, 234, 0.4);
    }
    
    button:disabled {
      opacity: 0.7;
      cursor: not-allowed;
    }
    
    button.loading {
      pointer-events: none;
      opacity: 0.8;
    }
    
    button.loading::after {
      content: '';
      position: absolute;
      width: 20px;
      height: 20px;
      top: 50%;
      left: 50%;
      margin-left: -10px;
      margin-top: -10px;
      border: 2px solid rgba(255,255,255,.3);
      border-radius: 50%;
      border-top-color: white;
      animation: spin 0.8s linear infinite;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    .results-container {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      margin-bottom: 20px;
    }
    
    .result-section {
      background: #f8f9fa;
      border: 2px solid #e0e0e0;
      border-radius: 12px;
      padding: 15px;
      display: flex;
      flex-direction: column;
    }
    
    .result-section h3 {
      color: #333;
      font-size: 16px;
      margin-bottom: 12px;
      padding-bottom: 8px;
      border-bottom: 2px solid #667eea;
      display: flex;
      align-items: center;
      gap: 8px;
      flex-shrink: 0;
    }
    
    .result-section.full-width {
      grid-column: 1 / -1;
    }
    
    /* ä¿®æ­£ï¼šç¢ºä¿çµæœæ¡†å¯ä»¥æ»¾å‹• */
    .result-box {
      flex: 1;
      min-height: 100px;
      max-height: 300px;
      overflow-y: auto;
      overflow-x: hidden;
      -webkit-overflow-scrolling: touch;
      overscroll-behavior: contain;
      font-family: 'Courier New', monospace;
      font-size: 13px;
      line-height: 1.6;
      color: #333;
      touch-action: pan-y;
    }
    
    .empty-state {
      color: #999;
      text-align: center;
      padding: 30px;
      font-style: italic;
    }
    
    .not-found {
      color: #f44336;
      text-align: center;
      padding: 40px;
      font-size: 18px;
      font-weight: bold;
    }
    
    .book-info-grid {
      display: grid;
      grid-template-columns: auto 1fr;
      gap: 8px 12px;
    }
    
    .book-info-label {
      color: #666;
      font-weight: 600;
    }
    
    .book-info-value {
      color: #333;
    }
    
    .library-count {
      font-size: 24px;
      font-weight: bold;
      color: #667eea;
      text-align: center;
      padding: 20px;
    }
    
    .library-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 12px;
      margin-top: 5px;
    }
    
    .library-table th {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 10px 8px;
      text-align: left;
      font-weight: 600;
      position: sticky;
      top: 0;
      z-index: 10;
    }
    
    .library-table td {
      padding: 8px;
      border-bottom: 1px solid #e0e0e0;
      background: white;
    }
    
    .library-table tr:hover td {
      background: #f5f5f5;
    }
    
    .text-muted {
      color: #999;
      font-style: italic;
    }
    
    /* å³å´ï¼šManualSelect ç®¡ç†é¢æ¿ */
    .right-panel {
      width: 350px;
      background: white;
      display: flex;
      flex-direction: column;
      box-shadow: -2px 0 10px rgba(0,0,0,0.1);
      transition: transform 0.3s ease;
      z-index: 50;
    }
    
    .panel-header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 15px;
      font-size: 16px;
      font-weight: bold;
      text-align: center;
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-shrink: 0;
    }
    
    .panel-content {
      flex: 1;
      padding: 15px;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 15px;
      -webkit-overflow-scrolling: touch;
    }
    
    .display-box {
      flex: 1;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      padding: 10px;
      font-family: 'Courier New', monospace;
      font-size: 13px;
      resize: none;
      background: #fafafa;
      transition: all 0.3s;
      min-height: 100px;
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
    }
    
    .display-box.updating {
      background: #e8f5e9;
      border-color: #4caf50;
    }
    
    .button-group {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    
    .btn {
      padding: 12px;
      border: none;
      border-radius: 6px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 5px;
      -webkit-tap-highlight-color: transparent;
    }
    
    .btn:active:not(:disabled) {
      transform: scale(0.98);
    }
    
    .btn-primary {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }
    
    .btn-primary:hover:not(:disabled) {
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
    }
    
    .btn-secondary {
      background: #f0f0f0;
      color: #333;
    }
    
    .btn-danger {
      background: #f44336;
      color: white;
    }
    
    .btn-warning {
      background: #ff9800;
      color: white;
    }
    
    .status-msg {
      font-size: 12px;
      text-align: center;
      color: #666;
      min-height: 20px;
      font-weight: 600;
    }
    
    .status-msg.success { color: #4caf50; }
    .status-msg.error { color: #f44336; }
    .status-msg.info { color: #2196f3; }
    
    #addInput {
      border: 2px solid #667eea;
      background: #f0f4ff;
      font-family: 'Courier New', monospace;
      font-size: 16px;
      letter-spacing: 2px;
    }
    
    #addInput:focus {
      background: white;
      box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.2);
    }
    
    /* æ‰‹æ©Ÿç«¯åˆ‡æ›æŒ‰éˆ• */
    .mobile-toggle {
      display: none;
      position: fixed;
      bottom: 20px;
      right: 20px;
      width: 60px;
      height: 60px;
      border-radius: 50%;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
      font-size: 24px;
      z-index: 100;
      cursor: pointer;
      align-items: center;
      justify-content: center;
    }
    
    .close-panel-btn {
      display: none;
      background: rgba(255,255,255,0.2);
      border: none;
      color: white;
      width: 32px;
      height: 32px;
      border-radius: 50%;
      cursor: pointer;
      font-size: 18px;
    }
    
    /* ==================== æ‰‹æ©Ÿç«¯é©é… ==================== */
    @media screen and (max-width: 768px) {
      body {
        overflow-y: auto;
        height: auto;
      }
      
      .container {
        flex-direction: column;
        overflow-y: visible;
        height: auto;
        min-height: 100vh;
      }
      
      .left-panel {
        width: 100%;
        padding: 20px;
        min-height: 100vh;
        height: auto;
        overflow-y: visible;
        padding-bottom: 100px;
      }
      
      .search-container {
        padding: 20px;
        max-width: 100%;
        overflow: visible;
      }
      
      h1 {
        font-size: 24px;
      }
      
      .subtitle {
        font-size: 14px;
      }
      
      input[type="text"] {
        padding: 15px;
        font-size: 16px;
      }
      
      button {
        padding: 15px;
        font-size: 16px;
      }
      
      .results-container {
        grid-template-columns: 1fr;
        gap: 15px;
      }
      
      /* ä¿®æ­£ï¼šæ‰‹æ©Ÿç«¯åœ–æ›¸é¤¨è³‡æ–™å€åŸŸå¯ä»¥æ­£å¸¸æ»¾å‹• */
      .result-section {
        max-height: none;
        overflow: visible;
      }
      
      .result-box {
        max-height: 400px;
        min-height: 150px;
        overflow-y: auto;
        -webkit-overflow-scrolling: touch;
        touch-action: pan-y;
      }
      
      /* ç¢ºä¿è¡¨æ ¼å¯ä»¥æ©«å‘æ»¾å‹• */
      .library-table {
        display: block;
        overflow-x: auto;
        white-space: nowrap;
        -webkit-overflow-scrolling: touch;
      }
      
      /* å³å´é¢æ¿æ”¹ç‚ºæŠ½å±œå¼ */
      .right-panel {
        position: fixed;
        top: 0;
        right: 0;
        width: 85%;
        height: 100vh;
        transform: translateX(100%);
        box-shadow: -5px 0 25px rgba(0,0,0,0.3);
        overflow-y: auto;
      }
      
      .right-panel.open {
        transform: translateX(0);
      }
      
      .mobile-toggle {
        display: flex;
      }
      
      .close-panel-btn {
        display: flex;
        align-items: center;
        justify-content: center;
      }
      
      /* é»æ“Šå¤–éƒ¨é—œé–‰çš„é®ç½© */
      .overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.5);
        z-index: 40;
      }
      
      .overlay.show {
        display: block;
      }
    }
    
    /* å¹³æ¿é©é…ï¼ˆä¸­ç­‰å±å¹•ï¼‰ */
    @media screen and (min-width: 769px) and (max-width: 1024px) {
      .right-panel {
        width: 300px;
      }
      
      .search-container {
        max-width: 100%;
      }
    }
  </style>
</head>
<body>
  <!-- é®ç½©å±¤ï¼ˆæ‰‹æ©Ÿç«¯é»æ“Šé—œé–‰é¢æ¿ï¼‰ -->
  <div class="overlay" id="overlay" onclick="togglePanel()"></div>
  
  <div class="container">
    <!-- å·¦å´ï¼šæœå°‹ä»‹é¢ -->
    <div class="left-panel">
      <div class="search-container">
        <h1>ğŸ” è³‡æ–™æŸ¥è©¢</h1>
        <p class="subtitle">è¼¸å…¥é—œéµå­—å¾ŒæŒ‰ Enter</p>
        
        <div class="input-group">
          <label for="inputBox">è¼¸å…¥é—œéµå­—ï¼ˆ14ä½ç´”æ•¸å­—ï¼‰</label>
          <input type="text" id="inputBox" placeholder="è«‹è¼¸å…¥14ä½ç´”æ•¸å­—..." autofocus maxlength="14" inputmode="numeric" pattern="[0-9]*">
          <div class="error-hint" id="errorHint">æ ¼å¼ä¸ç¬¦ï¼Œè«‹é‡æ–°è¼¸å…¥ï¼ˆå¿…é ˆæ˜¯14ä½ç´”æ•¸å­—ï¼‰</div>
        </div>
        
        <button id="queryBtn" onclick="submitQuery()">é€å‡ºæŸ¥è©¢</button>
        
        <div id="searchResults" style="display: none;">
          <div class="results-container">
            <div class="result-section">
              <h3>ğŸ“š å¯é¸é …ç›®</h3>
              <div class="result-box" id="libraryCountBox">
                <div class="empty-state">ç­‰å¾…æŸ¥è©¢...</div>
              </div>
            </div>
            
            <div class="result-section">
              <h3>ğŸ“– æ›¸æœ¬è³‡æ–™</h3>
              <div class="result-box" id="bookInfoBox">
                <div class="empty-state">ç­‰å¾…æŸ¥è©¢...</div>
              </div>
            </div>
            
            <div class="result-section full-width">
              <h3>ğŸ›ï¸ åœ–æ›¸é¤¨</h3>
              <div class="result-box" id="librariesBox">
                <div class="empty-state">ç­‰å¾…æŸ¥è©¢...</div>
              </div>
            </div>
          </div>
        </div>
        
        <div class="status-msg" id="searchStatus"></div>
      </div>
    </div>
    
    <!-- å³å´ï¼šManualSelect ç®¡ç†é¢æ¿ -->
    <div class="right-panel" id="rightPanel">
      <div class="panel-header">
        <span>ğŸ“‹ Manual Select</span>
        <button class="close-panel-btn" onclick="togglePanel()">âœ•</button>
      </div>
      
      <div class="panel-content">
        <div style="flex: 1; display: flex; flex-direction: column; min-height: 150px;">
          <label style="font-size: 12px; color: #666; margin-bottom: 5px; font-weight: 600;">
            ç›®å‰å…§å®¹ï¼ˆAæ¬„ï¼‰ï¼š
          </label>
          <textarea id="manualSelectDisplay" class="display-box" readonly placeholder="è¼‰å…¥ä¸­..."></textarea>
        </div>
        
        <div class="input-group">
          <label>æ–°å¢é …ç›®ï¼š</label>
          <input type="text" id="addInput" placeholder="æœç´¢å®Œæˆå¾Œè‡ªå‹•å¡«å…¥..." inputmode="numeric">
        </div>
        
        <div class="button-group">
          <button class="btn btn-primary" id="btnCopy" onclick="addToManualSelect()">
            <span>ğŸ“‹</span> è¤‡è£½ï¼ˆæ–°å¢ï¼‰
          </button>
          
          <div style="display: flex; gap: 8px;">
            <button class="btn btn-danger" style="flex: 1; font-size: 12px; padding: 10px;" onclick="clearAll()">
              æ¸…é™¤å…¨éƒ¨
            </button>
            <button class="btn btn-warning" style="flex: 1; font-size: 12px; padding: 10px;" onclick="removeLast()">
              æ¸…é™¤æœ€å¾Œ
            </button>
          </div>
          
          <button class="btn btn-secondary" onclick="exportToTxt()">
            <span>ğŸ’¾</span> åŒ¯å‡º TXT
          </button>
        </div>
        
        <div class="status-msg" id="manualStatus"></div>
      </div>
    </div>
  </div>
  
  <!-- æ‰‹æ©Ÿç«¯æµ®å‹•åˆ‡æ›æŒ‰éˆ• -->
  <button class="mobile-toggle" id="mobileToggle" onclick="togglePanel()" title="é–‹å•Ÿ Manual Select">
    ğŸ“‹
  </button>

  <script>
    // API åŸºç¤ç¶²å€
    const GAS_API_URL = 'https://script.google.com/macros/s/AKfycbxMmID7MyEb-Z-98RPUzpa4NjyuPp6B7rPrBNFJGJ_4d8BDlL-rRkoJq3iyzsZCDOhY8w/exec ';
    
    // æœ¬åœ°è³‡æ–™ç·©å­˜
    let manualSelectData = [];
    let isPanelOpen = false;
    
    // é é¢è¼‰å…¥æ™‚è‡ªå‹•è¼‰å…¥ ManualSelect è³‡æ–™
    window.onload = function() {
      loadManualSelect();
      // æª¢æ¸¬æ˜¯å¦ç‚ºæ‰‹æ©Ÿç«¯ï¼Œå¦‚æœæ˜¯ä¸”å±å¹•å°ï¼Œé»˜èªé—œé–‰å³å´é¢æ¿
      if (window.innerWidth <= 768) {
        closePanel();
      }
    };
    
    // ç›£è½çª—å£å¤§å°è®ŠåŒ–
    window.addEventListener('resize', () => {
      if (window.innerWidth > 768) {
        // æ¡Œé¢ç«¯å¼·åˆ¶é¡¯ç¤º
        document.getElementById('rightPanel').classList.remove('open');
        document.getElementById('overlay').classList.remove('show');
        isPanelOpen = false;
      }
    });
    
    // åˆ‡æ›é¢æ¿é¡¯ç¤ºï¼ˆæ‰‹æ©Ÿç«¯ç”¨ï¼‰
    function togglePanel() {
      const panel = document.getElementById('rightPanel');
      const overlay = document.getElementById('overlay');
      const toggleBtn = document.getElementById('mobileToggle');
      
      isPanelOpen = !isPanelOpen;
      
      if (isPanelOpen) {
        panel.classList.add('open');
        overlay.classList.add('show');
        toggleBtn.style.display = 'none';
        // ç¦æ­¢èƒŒæ™¯æ»¾å‹•
        document.body.style.overflow = 'hidden';
      } else {
        closePanel();
      }
    }
    
    function closePanel() {
      const panel = document.getElementById('rightPanel');
      const overlay = document.getElementById('overlay');
      const toggleBtn = document.getElementById('mobileToggle');
      
      panel.classList.remove('open');
      overlay.classList.remove('show');
      isPanelOpen = false;
      toggleBtn.style.display = 'flex';
      // æ¢å¾©èƒŒæ™¯æ»¾å‹•
      if (window.innerWidth <= 768) {
        document.body.style.overflow = 'auto';
      }
    }
    
    // é¡¯ç¤ºç‹€æ…‹è¨Šæ¯
    function showStatus(msg, type = '', isSearch = false) {
      const statusEl = isSearch ? document.getElementById('searchStatus') : document.getElementById('manualStatus');
      statusEl.textContent = msg;
      statusEl.className = 'status-msg ' + type;
      if (type !== 'info') {
        setTimeout(() => {
          statusEl.textContent = '';
          statusEl.className = 'status-msg';
        }, 3000);
      }
    }
    
    //========== æœå°‹åŠŸèƒ½ï¼ˆå·¦å´ï¼‰ ==========
    
    function validateInput(value) {
      return /^\\d{14}$/.test(value);
    }
    
    async function submitQuery() {
      const inputBox = document.getElementById('inputBox');
      const inputValue = inputBox.value.trim();
      const btn = document.getElementById('queryBtn');
      const errorHint = document.getElementById('errorHint');
      
      if (!validateInput(inputValue)) {
        inputBox.classList.add('error');
        errorHint.classList.add('show');
        return;
      }
      
      inputBox.classList.remove('error');
      errorHint.classList.remove('show');
      
      btn.classList.add('loading');
      btn.textContent = 'åŸ·è¡Œä¸­...';
      
      try {
        const response = await fetch(`${GAS_API_URL}?action=query&input=${encodeURIComponent(inputValue)}`);
        const data = await response.json();
        
        document.getElementById('searchResults').style.display = 'block';
        
        if (data.success) {
          if (data.a1Value && data.a1Value.toString().includes('æ‰¾ä¸åˆ°ç›¸æ‡‰å€¼')) {
            showNotFound(data.a1Value);
            document.getElementById('addInput').value = '';
          } else {
            displaySearchResults(data);
            showStatus(`âœ… å…± ${data.rowCount} ç­†çµæœ`, 'success', true);
            document.getElementById('addInput').value = inputValue;
            showStatus('âœ… å·²è‡ªå‹•å¡«å…¥14ä½æ•¸å­—', 'success');
          }
        } else {
          showStatus('âŒ ' + data.error, 'error', true);
          document.getElementById('addInput').value = '';
        }
      } catch (error) {
        showStatus('âŒ é€£ç·šéŒ¯èª¤ï¼š' + error.message, 'error', true);
        document.getElementById('addInput').value = '';
      } finally {
        btn.classList.remove('loading');
        btn.textContent = 'é€å‡ºæŸ¥è©¢';
        inputBox.value = '';
      }
    }
    
    function showNotFound(a1Value) {
      const notFoundHtml = '<div class="not-found">âŒ æ‰¾ä¸åˆ°ç›¸æ‡‰å€¼</div>';
      document.getElementById('libraryCountBox').innerHTML = notFoundHtml;
      document.getElementById('bookInfoBox').innerHTML = notFoundHtml;
      document.getElementById('librariesBox').innerHTML = notFoundHtml;
      showStatus('âŒ ' + a1Value, 'error', true);
    }
    
    function displaySearchResults(data) {
      const bookInfo = data.bookInfo || {};
      const libraries = data.libraries || [];
      const libraryCount = data.libraryCount || 0;
      
      document.getElementById('libraryCountBox').innerHTML = 
        `<div class="library-count">${libraryCount}<div style="font-size: 14px; color: #666; margin-top: 5px;">å€‹é …ç›®</div></div>`;
      
      document.getElementById('bookInfoBox').innerHTML = `
        <div class="book-info-grid">
          <div class="book-info-label">æ›¸å:</div><div class="book-info-value">${bookInfo.title || 'N/A'}</div>
          <div class="book-info-label">é¤¨è—ç·¨ç›®è™Ÿç¢¼:</div><div class="book-info-value">${bookInfo.catalogNo || 'N/A'}</div>
          <div class="book-info-label">ç´¢æ›¸è™Ÿ:</div><div class="book-info-value">${bookInfo.callNo || 'N/A'}</div>
          <div class="book-info-label">è‘—è€…:</div><div class="book-info-value">${bookInfo.author || 'N/A'}</div>
          <div class="book-info-label">è‘—éŒ„:</div><div class="book-info-value">${bookInfo.description || 'N/A'}</div>
          <div class="book-info-label">å‡ºç‰ˆåœ°:</div><div class="book-info-value">${bookInfo.pubLoc || 'N/A'}</div>
          <div class="book-info-label">å‡ºç‰ˆè€…:</div><div class="book-info-value">${bookInfo.publisher || 'N/A'}</div>
          <div class="book-info-label">å‡ºç‰ˆå¹´ä»½:</div><div class="book-info-value">${bookInfo.pubYear || 'N/A'}</div>
          <div class="book-info-label">å¢æ›¸å:</div><div class="book-info-value">${bookInfo.series || 'N/A'}</div>
        </div>
      `;
      
      if (libraries.length > 0) {
        let tableHtml = `
          <table class="library-table">
            <thead>
              <tr>
                <th>åœ–æ›¸é¤¨</th>
                <th>ç´¢æ›¸è™Ÿ</th>
                <th>æœŸæ¬¡</th>
                <th>åª’é«”ç¢¼</th>
                <th>é¤¨è—ç¾æ³</th>
                <th>é¤¨è—</th>
              </tr>
            </thead>
            <tbody>
        `;
        
        libraries.forEach((lib) => {
          tableHtml += `
            <tr>
              <td>${lib.library || ''}</td>
              <td>${lib.callNumber || ''}</td>
              <td>${lib.issue || '<span class="text-muted">-</span>'}</td>
              <td>${lib.mediaCode || '<span class="text-muted">-</span>'}</td>
              <td>${lib.status || ''}</td>
              <td>${lib.collection || ''}</td>
            </tr>
          `;
        });
        
        tableHtml += '</tbody></table>';
        document.getElementById('librariesBox').innerHTML = tableHtml;
      } else {
        document.getElementById('librariesBox').innerHTML = '<div class="empty-state">ç„¡åœ–æ›¸é¤¨è³‡æ–™</div>';
      }
    }
    
    //========== Manual Select åŠŸèƒ½ï¼ˆå³å´ï¼‰ ==========
    
    function updateDisplay() {
      const display = document.getElementById('manualSelectDisplay');
      display.value = manualSelectData.length > 0 ? manualSelectData.join('\\n') : '(ç„¡è³‡æ–™)';
      display.classList.add('updating');
      setTimeout(() => display.classList.remove('updating'), 300);
    }
    
    async function loadManualSelect() {
      try {
        const response = await fetch(`${GAS_API_URL}?action=getManualSelect`);
        const data = await response.json();
        
        if (data.success) {
          manualSelectData = data.data || [];
          updateDisplay();
        } else {
          showStatus('è¼‰å…¥å¤±æ•—ï¼š' + data.error, 'error');
        }
      } catch (error) {
        showStatus('è¼‰å…¥éŒ¯èª¤ï¼š' + error.message, 'error');
      }
    }
    
    async function addToManualSelect() {
      const input = document.getElementById('addInput');
      const value = input.value.trim();
      
      if (!value) {
        showStatus('è«‹å…ˆè¼¸å…¥è³‡æ–™', 'error');
        return;
      }
      
      manualSelectData.push(value);
      updateDisplay();
      input.value = '';
      showStatus('âœ… å·²æ–°å¢ï¼ˆåŒæ­¥ä¸­...ï¼‰', 'info');
      
      // æ‰‹æ©Ÿç«¯è‡ªå‹•é—œé–‰é¢æ¿ï¼ˆå¯é¸ï¼‰
      if (window.innerWidth <= 768 && isPanelOpen) {
        setTimeout(() => closePanel(), 500);
      }
      
      const btn = document.getElementById('btnCopy');
      btn.disabled = true;
      
      try {
        const response = await fetch(`${GAS_API_URL}?action=addToManualSelect&value=${encodeURIComponent(value)}`);
        const data = await response.json();
        
        if (data.success) {
          showStatus('âœ… åŒæ­¥å®Œæˆ', 'success');
        } else {
          manualSelectData.pop();
          updateDisplay();
          input.value = value;
          showStatus('âŒ ' + data.error, 'error');
        }
      } catch (error) {
        manualSelectData.pop();
        updateDisplay();
        input.value = value;
        showStatus('âŒ åŒæ­¥å¤±æ•—ï¼Œè«‹é‡è©¦', 'error');
      } finally {
        btn.disabled = false;
      }
    }
    
    async function clearAll() {
      if (!confirm('ç¢ºå®šè¦æ¸…é™¤ A æ¬„æ‰€æœ‰è³‡æ–™å—ï¼Ÿæ­¤å‹•ä½œç„¡æ³•å¾©åŸã€‚')) return;
      
      const originalData = [...manualSelectData];
      manualSelectData = [];
      updateDisplay();
      showStatus('ğŸ—‘ï¸ å·²æ¸…é™¤ï¼ˆåŒæ­¥ä¸­...ï¼‰', 'info');
      
      try {
        const response = await fetch(`${GAS_API_URL}?action=clearManualSelect`);
        const data = await response.json();
        
        if (data.success) {
          showStatus('âœ… åŒæ­¥å®Œæˆ', 'success');
        } else {
          manualSelectData = originalData;
          updateDisplay();
          showStatus('âŒ ' + data.error, 'error');
        }
      } catch (error) {
        manualSelectData = originalData;
        updateDisplay();
        showStatus('âŒ åŒæ­¥å¤±æ•—', 'error');
      }
    }
    
    async function removeLast() {
      if (manualSelectData.length === 0) {
        showStatus('æ²’æœ‰å¯æ¸…é™¤çš„è³‡æ–™', 'error');
        return;
      }
      
      const originalData = [...manualSelectData];
      manualSelectData.pop();
      updateDisplay();
      showStatus('ğŸ—‘ï¸ å·²ç§»é™¤ï¼ˆåŒæ­¥ä¸­...ï¼‰', 'info');
      
      try {
        const response = await fetch(`${GAS_API_URL}?action=removeLastManualSelect`);
        const data = await response.json();
        
        if (data.success) {
          showStatus('âœ… åŒæ­¥å®Œæˆ', 'success');
        } else {
          manualSelectData = originalData;
          updateDisplay();
          showStatus('âŒ ' + data.error, 'error');
        }
      } catch (error) {
        manualSelectData = originalData;
        updateDisplay();
        showStatus('âŒ åŒæ­¥å¤±æ•—', 'error');
      }
    }
    
    async function exportToTxt() {
      try {
        if (manualSelectData.length === 0) {
          showStatus('ç„¡è³‡æ–™å¯åŒ¯å‡º', 'error');
          return;
        }
        
        const content = manualSelectData.join('\\n');
        const blob = new Blob([content], { type: 'text/plain;charset=utf-8' });
        const url = URL.createObjectURL(blob);
        
        const a = document.createElement('a');
        a.href = url;
        a.download = `ManualSelect_${new Date().toISOString().slice(0,10)}.txt`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        
        showStatus('âœ… å·²åŒ¯å‡º TXT', 'success');
      } catch (error) {
        showStatus('âŒ åŒ¯å‡ºå¤±æ•—ï¼š' + error.message, 'error');
      }
    }
    
    // å®šæœŸåŒæ­¥
    setInterval(() => {
      loadManualSelect();
    }, 10000);
    
    // é é¢é‡æ–°ç²å¾—ç„¦é»æ™‚åŒæ­¥
    window.addEventListener('focus', () => {
      loadManualSelect();
    });
    
    // è¼¸å…¥æ¡†å³æ™‚é©—è­‰
    document.getElementById('inputBox').addEventListener('input', function() {
      const value = this.value.replace(/\\D/g, '');
      if (this.value !== value) this.value = value;
      if (value.length > 14) this.value = value.substring(0, 14);
    });
    
    // Enter éµæäº¤
    document.getElementById('inputBox').addEventListener('keypress', function(e) {
      if (e.key === 'Enter') submitQuery();
    });
    
    // é˜²æ­¢è§¸æ§äº‹ä»¶è¡çª - å…è¨±çµæœå€åŸŸæ­£å¸¸æ»¾å‹•
    document.querySelectorAll('.result-box').forEach(box => {
      box.addEventListener('touchstart', function(e) {
        // å…è¨±é»˜èªè¡Œç‚ºï¼Œä¸å¹²é æ»¾å‹•
      }, { passive: true });
    });
  </script>
</body>
</html>'''

print("å·²ç”Ÿæˆä¿®æ­£å¾Œçš„ HTML ä»£ç¢¼")
print("ä¸»è¦ä¿®æ­£é»ï¼š")
print("1. æ‰‹æ©Ÿç«¯ body/left-panel è¨­ç‚º overflow-y: visible/overflow-y: autoï¼Œå…è¨±è‡ªç„¶æ»¾å‹•")
print("2. .result-box æ·»åŠ  touch-action: pan-y å’Œ overscroll-behavior: contain")
print("3. æ‰‹æ©Ÿç«¯ .result-section ç§»é™¤ overflow é™åˆ¶ï¼Œ.result-box ä¿æŒç¨ç«‹æ»¾å‹•")
print("4. åœ–æ›¸é¤¨è¡¨æ ¼æ·»åŠ  overflow-x: auto æ”¯æŒæ©«å‘æ»¾å‹•æŸ¥çœ‹")
print("5. å³å´é¢æ¿æ‰“é–‹æ™‚ç¦æ­¢èƒŒæ™¯æ»¾å‹•ï¼Œé—œé–‰æ™‚æ¢å¾©")
print("6. æ·»åŠ  passive touchstart äº‹ä»¶ç›£è½é¿å…æ»¾å‹•å¡é “")
