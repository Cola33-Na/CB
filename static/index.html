<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>è³‡æ–™æŸ¥è©¢èˆ‡ç®¡ç†</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { 
      font-family: 'Segoe UI', system-ui, sans-serif; 
      height: 100vh;
      overflow: hidden;
      background: #f5f5f5;
    }
    
    .container {
      display: flex;
      height: 100vh;
    }
    
    /* å·¦å´ï¼šæœå°‹ä»‹é¢ï¼ˆå–ä»£ iframeï¼‰ */
    .left-panel {
      flex: 1;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      padding: 40px;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    
    .search-container {
      background: white;
      border-radius: 20px;
      padding: 40px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
      width: 100%;
      max-width: 600px;
      animation: slideIn 0.5s ease-out;
    }
    
    @keyframes slideIn {
      from { opacity: 0; transform: translateY(-30px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    h1 {
      color: #333;
      margin-bottom: 10px;
      font-size: 28px;
      text-align: center;
    }
    
    .subtitle {
      color: #666;
      text-align: center;
      margin-bottom: 30px;
      font-size: 14px;
    }
    
    .input-group {
      margin-bottom: 25px;
    }
    
    label {
      display: block;
      margin-bottom: 8px;
      color: #555;
      font-weight: 600;
      font-size: 14px;
    }
    
    input[type="text"] {
      width: 100%;
      padding: 15px;
      border: 2px solid #e0e0e0;
      border-radius: 12px;
      font-size: 16px;
      transition: all 0.3s;
      background: #f8f9fa;
    }
    
    input[type="text"]:focus {
      outline: none;
      border-color: #667eea;
      background: white;
      box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.1);
    }
    
    input[type="text"].error {
      border-color: #f44336;
      background: #ffebee;
    }
    
    .error-hint {
      color: #f44336;
      font-size: 12px;
      margin-top: 5px;
      display: none;
    }
    
    .error-hint.show {
      display: block;
    }
    
    button {
      width: 100%;
      padding: 15px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      border-radius: 12px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
      margin-bottom: 25px;
      position: relative;
      overflow: hidden;
    }
    
    button:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 25px rgba(102, 126, 234, 0.4);
    }
    
    button.loading {
      pointer-events: none;
      opacity: 0.8;
    }
    
    button.loading::after {
      content: '';
      position: absolute;
      width: 20px;
      height: 20px;
      top: 50%;
      left: 50%;
      margin-left: -10px;
      margin-top: -10px;
      border: 2px solid rgba(255,255,255,.3);
      border-radius: 50%;
      border-top-color: white;
      animation: spin 0.8s linear infinite;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    .results-container {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      margin-bottom: 20px;
    }
    
    .result-section {
      background: #f8f9fa;
      border: 2px solid #e0e0e0;
      border-radius: 12px;
      padding: 15px;
    }
    
    .result-section h3 {
      color: #333;
      font-size: 16px;
      margin-bottom: 12px;
      padding-bottom: 8px;
      border-bottom: 2px solid #667eea;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .result-section.full-width {
      grid-column: 1 / -1;
    }
    
    .result-box {
      min-height: 100px;
      max-height: 300px;
      overflow-y: auto;
      font-family: 'Courier New', monospace;
      font-size: 13px;
      line-height: 1.6;
      color: #333;
    }
    
    .empty-state {
      color: #999;
      text-align: center;
      padding: 30px;
      font-style: italic;
    }
    
    .not-found {
      color: #f44336;
      text-align: center;
      padding: 40px;
      font-size: 18px;
      font-weight: bold;
    }
    
    .book-info-grid {
      display: grid;
      grid-template-columns: auto 1fr;
      gap: 8px 12px;
    }
    
    .book-info-label {
      color: #666;
      font-weight: 600;
    }
    
    .book-info-value {
      color: #333;
    }
    
    .library-count {
      font-size: 24px;
      font-weight: bold;
      color: #667eea;
      text-align: center;
      padding: 20px;
    }
    
    .library-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 12px;
      margin-top: 5px;
    }
    
    .library-table th {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 10px 8px;
      text-align: left;
      font-weight: 600;
      position: sticky;
      top: 0;
      z-index: 10;
    }
    
    .library-table td {
      padding: 8px;
      border-bottom: 1px solid #e0e0e0;
      background: white;
    }
    
    .library-table tr:hover td {
      background: #f5f5f5;
    }
    
    .text-muted {
      color: #999;
      font-style: italic;
    }
    
    /* å³å´ï¼šManualSelect ç®¡ç†é¢æ¿ */
    .right-panel {
      width: 350px;
      background: white;
      display: flex;
      flex-direction: column;
      box-shadow: -2px 0 10px rgba(0,0,0,0.1);
    }
    
    .panel-header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 15px;
      font-size: 16px;
      font-weight: bold;
      text-align: center;
    }
    
    .panel-content {
      flex: 1;
      padding: 15px;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 15px;
    }
    
    .display-box {
      flex: 1;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      padding: 10px;
      font-family: 'Courier New', monospace;
      font-size: 13px;
      resize: none;
      background: #fafafa;
    }
    
    .button-group {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    
    .btn {
      padding: 12px;
      border: none;
      border-radius: 6px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 5px;
    }
    
    .btn-primary {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }
    
    .btn-primary:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
    }
    
    .btn-secondary {
      background: #f0f0f0;
      color: #333;
    }
    
    .btn-danger {
      background: #f44336;
      color: white;
    }
    
    .btn-warning {
      background: #ff9800;
      color: white;
    }
    
    .status-msg {
      font-size: 12px;
      text-align: center;
      color: #666;
      min-height: 20px;
    }
    
    .status-msg.success { color: #4caf50; }
    .status-msg.error { color: #f44336; }
  </style>
</head>
<body>
  <div class="container">
    <!-- å·¦å´ï¼šæœå°‹ä»‹é¢ï¼ˆç´”å‰ç«¯ï¼Œé€é API èˆ‡ GAS é€šä¿¡ï¼‰ -->
    <div class="left-panel">
      <div class="search-container">
        <h1>ğŸ” è³‡æ–™æŸ¥è©¢</h1>
        <p class="subtitle">è¼¸å…¥é—œéµå­—å¾ŒæŒ‰ Enter</p>
        
        <div class="input-group">
          <label for="inputBox">è¼¸å…¥é—œéµå­—ï¼ˆ14ä½ç´”æ•¸å­—ï¼‰</label>
          <input type="text" id="inputBox" placeholder="è«‹è¼¸å…¥14ä½ç´”æ•¸å­—..." autofocus maxlength="14">
          <div class="error-hint" id="errorHint">æ ¼å¼ä¸ç¬¦ï¼Œè«‹é‡æ–°è¼¸å…¥ï¼ˆå¿…é ˆæ˜¯14ä½ç´”æ•¸å­—ï¼‰</div>
        </div>
        
        <button id="queryBtn" onclick="submitQuery()">é€å‡ºæŸ¥è©¢</button>
        
        <div id="searchResults" style="display: none;">
          <div class="results-container">
            <div class="result-section">
              <h3>ğŸ“š å¯é¸é …ç›®</h3>
              <div class="result-box" id="libraryCountBox">
                <div class="empty-state">ç­‰å¾…æŸ¥è©¢...</div>
              </div>
            </div>
            
            <div class="result-section">
              <h3>ğŸ“– æ›¸æœ¬è³‡æ–™</h3>
              <div class="result-box" id="bookInfoBox">
                <div class="empty-state">ç­‰å¾…æŸ¥è©¢...</div>
              </div>
            </div>
            
            <div class="result-section full-width">
              <h3>ğŸ›ï¸ åœ–æ›¸é¤¨</h3>
              <div class="result-box" id="librariesBox">
                <div class="empty-state">ç­‰å¾…æŸ¥è©¢...</div>
              </div>
            </div>
          </div>
        </div>
        
        <div class="status-msg" id="searchStatus"></div>
      </div>
    </div>
    
    <!-- å³å´ï¼šManualSelect ç®¡ç†é¢æ¿ -->
    <div class="right-panel">
      <div class="panel-header">
        ğŸ“‹ Manual Select ç®¡ç†
      </div>
      
      <div class="panel-content">
        <div style="flex: 1; display: flex; flex-direction: column;">
          <label style="font-size: 12px; color: #666; margin-bottom: 5px; font-weight: 600;">
            ç›®å‰å…§å®¹ï¼ˆAæ¬„ï¼‰ï¼š
          </label>
          <textarea id="manualSelectDisplay" class="display-box" readonly placeholder="è¼‰å…¥ä¸­..."></textarea>
        </div>
        
        <div class="input-group">
          <label>æ–°å¢é …ç›®ï¼š</label>
          <input type="text" id="addInput" placeholder="è¼¸å…¥è³‡æ–™å¾ŒæŒ‰è¤‡è£½...">
        </div>
        
        <div class="button-group">
          <button class="btn btn-primary" id="btnCopy" onclick="addToManualSelect()">
            <span>ğŸ“‹</span> è¤‡è£½ï¼ˆæ–°å¢ï¼‰
          </button>
          
          <div style="display: flex; gap: 8px;">
            <button class="btn btn-danger" style="flex: 1;" onclick="clearAll()">
              æ¸…é™¤å…¨éƒ¨
            </button>
            <button class="btn btn-warning" style="flex: 1;" onclick="removeLast()">
              æ¸…é™¤æœ€å¾Œä¸€é …
            </button>
          </div>
          
          <button class="btn btn-secondary" onclick="exportToTxt()">
            <span>ğŸ’¾</span> åŒ¯å‡º TXT
          </button>
        </div>
        
        <div class="status-msg" id="manualStatus"></div>
      </div>
    </div>
  </div>

  <script>
    // API åŸºç¤ç¶²å€
    const GAS_API_URL = 'https://script.google.com/macros/s/AKfycbxMmID7MyEb-Z-98RPUzpa4NjyuPp6B7rPrBNFJGJ_4d8BDlL-rRkoJq3iyzsZCDOhY8w/exec';
    
    // é é¢è¼‰å…¥æ™‚è‡ªå‹•è¼‰å…¥ ManualSelect è³‡æ–™
    window.onload = function() {
      loadManualSelect();
    };
    
    // é¡¯ç¤ºç‹€æ…‹è¨Šæ¯
    function showStatus(msg, type = '', isSearch = false) {
      const statusEl = isSearch ? document.getElementById('searchStatus') : document.getElementById('manualStatus');
      statusEl.textContent = msg;
      statusEl.className = 'status-msg ' + type;
      setTimeout(() => {
        statusEl.textContent = '';
        statusEl.className = 'status-msg';
      }, 3000);
    }
    
    //========== æœå°‹åŠŸèƒ½ï¼ˆå·¦å´ï¼‰ ==========
    
    function validateInput(value) {
      return /^\d{14}$/.test(value);
    }
    
    async function submitQuery() {
      const inputBox = document.getElementById('inputBox');
      const inputValue = inputBox.value.trim();
      const btn = document.getElementById('queryBtn');
      const errorHint = document.getElementById('errorHint');
      
      if (!validateInput(inputValue)) {
        inputBox.classList.add('error');
        errorHint.classList.add('show');
        return;
      }
      
      inputBox.classList.remove('error');
      errorHint.classList.remove('show');
      
      btn.classList.add('loading');
      btn.textContent = 'åŸ·è¡Œä¸­...';
      
      try {
        const response = await fetch(`${GAS_API_URL}?action=query&input=${encodeURIComponent(inputValue)}`);
        const data = await response.json();
        
        document.getElementById('searchResults').style.display = 'block';
        
        if (data.success) {
          if (data.a1Value && data.a1Value.toString().includes('æ‰¾ä¸åˆ°ç›¸æ‡‰å€¼')) {
            showNotFound(data.a1Value);
          } else {
            displaySearchResults(data);
            showStatus(`âœ… å…± ${data.rowCount} ç­†çµæœ`, 'success', true);
          }
        } else {
          showStatus('âŒ ' + data.error, 'error', true);
        }
      } catch (error) {
        showStatus('âŒ é€£ç·šéŒ¯èª¤ï¼š' + error.message, 'error', true);
      } finally {
        btn.classList.remove('loading');
        btn.textContent = 'é€å‡ºæŸ¥è©¢';
      }
    }
    
    function showNotFound(a1Value) {
      const notFoundHtml = '<div class="not-found">âŒ æ‰¾ä¸åˆ°ç›¸æ‡‰å€¼</div>';
      document.getElementById('libraryCountBox').innerHTML = notFoundHtml;
      document.getElementById('bookInfoBox').innerHTML = notFoundHtml;
      document.getElementById('librariesBox').innerHTML = notFoundHtml;
      showStatus('âŒ ' + a1Value, 'error', true);
    }
    
    function displaySearchResults(data) {
      const bookInfo = data.bookInfo || {};
      const libraries = data.libraries || [];
      const libraryCount = data.libraryCount || 0;
      
      // é¡¯ç¤ºå¯é¸åœ–æ›¸é¤¨æ•¸é‡
      document.getElementById('libraryCountBox').innerHTML = 
        `<div class="library-count">${libraryCount}<div style="font-size: 14px; color: #666; margin-top: 5px;">å€‹é …ç›®</div></div>`;
      
      // é¡¯ç¤ºæ›¸æœ¬è³‡æ–™
      document.getElementById('bookInfoBox').innerHTML = `
        <div class="book-info-grid">
          <div class="book-info-label">æ›¸å:</div><div class="book-info-value">${bookInfo.title || 'N/A'}</div>
          <div class="book-info-label">é¤¨è—ç·¨ç›®è™Ÿç¢¼:</div><div class="book-info-value">${bookInfo.catalogNo || 'N/A'}</div>
          <div class="book-info-label">ç´¢æ›¸è™Ÿ:</div><div class="book-info-value">${bookInfo.callNo || 'N/A'}</div>
          <div class="book-info-label">è‘—è€…:</div><div class="book-info-value">${bookInfo.author || 'N/A'}</div>
          <div class="book-info-label">è‘—éŒ„:</div><div class="book-info-value">${bookInfo.description || 'N/A'}</div>
          <div class="book-info-label">å‡ºç‰ˆåœ°:</div><div class="book-info-value">${bookInfo.pubLoc || 'N/A'}</div>
          <div class="book-info-label">å‡ºç‰ˆè€…:</div><div class="book-info-value">${bookInfo.publisher || 'N/A'}</div>
          <div class="book-info-label">å‡ºç‰ˆå¹´ä»½:</div><div class="book-info-value">${bookInfo.pubYear || 'N/A'}</div>
          <div class="book-info-label">å¢æ›¸å:</div><div class="book-info-value">${bookInfo.series || 'N/A'}</div>
        </div>
      `;
      
      // é¡¯ç¤ºåœ–æ›¸é¤¨åˆ—è¡¨
      if (libraries.length > 0) {
        let tableHtml = `
          <table class="library-table">
            <thead>
              <tr>
                <th>åœ–æ›¸é¤¨</th>
                <th>ç´¢æ›¸è™Ÿ</th>
                <th>æœŸæ¬¡</th>
                <th>åª’é«”ç¢¼</th>
                <th>é¤¨è—ç¾æ³</th>
                <th>é¤¨è—</th>
              </tr>
            </thead>
            <tbody>
        `;
        
        libraries.forEach((lib) => {
          tableHtml += `
            <tr>
              <td>${lib.library || ''}</td>
              <td>${lib.callNumber || ''}</td>
              <td>${lib.issue || '<span class="text-muted">-</span>'}</td>
              <td>${lib.mediaCode || '<span class="text-muted">-</span>'}</td>
              <td>${lib.status || ''}</td>
              <td>${lib.collection || ''}</td>
            </tr>
          `;
        });
        
        tableHtml += '</tbody></table>';
        document.getElementById('librariesBox').innerHTML = tableHtml;
      } else {
        document.getElementById('librariesBox').innerHTML = '<div class="empty-state">ç„¡åœ–æ›¸é¤¨è³‡æ–™</div>';
      }
    }
    
    //========== Manual Select åŠŸèƒ½ï¼ˆå³å´ï¼‰ ==========
    
    async function loadManualSelect() {
      try {
        const response = await fetch(`${GAS_API_URL}?action=getManualSelect`);
        const data = await response.json();
        
        if (data.success) {
          const display = document.getElementById('manualSelectDisplay');
          display.value = data.data && data.data.length > 0 ? data.data.join('\n') : '(ç„¡è³‡æ–™)';
        } else {
          showStatus('è¼‰å…¥å¤±æ•—ï¼š' + data.error, 'error');
        }
      } catch (error) {
        showStatus('è¼‰å…¥éŒ¯èª¤ï¼š' + error.message, 'error');
      }
    }
    
    async function addToManualSelect() {
      const input = document.getElementById('addInput');
      const value = input.value.trim();
      
      if (!value) {
        showStatus('è«‹å…ˆè¼¸å…¥è³‡æ–™', 'error');
        return;
      }
      
      const btn = document.getElementById('btnCopy');
      btn.disabled = true;
      btn.innerHTML = 'è™•ç†ä¸­...';
      
      try {
        const response = await fetch(`${GAS_API_URL}?action=addToManualSelect&value=${encodeURIComponent(value)}`);
        const data = await response.json();
        
        if (data.success) {
          showStatus('âœ… å·²æ–°å¢è‡³ A æ¬„', 'success');
          input.value = '';
          await loadManualSelect();
        } else {
          showStatus('âŒ ' + data.error, 'error');
        }
      } catch (error) {
        showStatus('âŒ éŒ¯èª¤ï¼š' + error.message, 'error');
      } finally {
        btn.disabled = false;
        btn.innerHTML = '<span>ğŸ“‹</span> è¤‡è£½ï¼ˆæ–°å¢ï¼‰';
      }
    }
    
    async function clearAll() {
      if (!confirm('ç¢ºå®šè¦æ¸…é™¤ A æ¬„æ‰€æœ‰è³‡æ–™å—ï¼Ÿæ­¤å‹•ä½œç„¡æ³•å¾©åŸã€‚')) return;
      
      try {
        const response = await fetch(`${GAS_API_URL}?action=clearManualSelect`);
        const data = await response.json();
        
        if (data.success) {
          showStatus('âœ… å·²æ¸…é™¤å…¨éƒ¨è³‡æ–™', 'success');
          await loadManualSelect();
        } else {
          showStatus('âŒ ' + data.error, 'error');
        }
      } catch (error) {
        showStatus('âŒ éŒ¯èª¤ï¼š' + error.message, 'error');
      }
    }
    
    async function removeLast() {
      try {
        const response = await fetch(`${GAS_API_URL}?action=removeLastManualSelect`);
        const data = await response.json();
        
        if (data.success) {
          showStatus('âœ… å·²æ¸…é™¤æœ€å¾Œä¸€é …', 'success');
          await loadManualSelect();
        } else {
          showStatus('âŒ ' + data.error, 'error');
        }
      } catch (error) {
        showStatus('âŒ éŒ¯èª¤ï¼š' + error.message, 'error');
      }
    }
    
    async function exportToTxt() {
      try {
        const response = await fetch(`${GAS_API_URL}?action=getManualSelect`);
        const data = await response.json();
        
        if (!data.success || !data.data || data.data.length === 0) {
          showStatus('ç„¡è³‡æ–™å¯åŒ¯å‡º', 'error');
          return;
        }
        
        const content = data.data.join('\n');
        const blob = new Blob([content], { type: 'text/plain;charset=utf-8' });
        const url = URL.createObjectURL(blob);
        
        const a = document.createElement('a');
        a.href = url;
        a.download = `ManualSelect_${new Date().toISOString().slice(0,10)}.txt`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        
        showStatus('âœ… å·²åŒ¯å‡º TXT', 'success');
      } catch (error) {
        showStatus('âŒ åŒ¯å‡ºå¤±æ•—ï¼š' + error.message, 'error');
      }
    }
    
    // å®šæœŸè‡ªå‹•æ›´æ–°ï¼ˆæ¯ 30 ç§’ï¼‰
    setInterval(loadManualSelect, 30000);
    
    // è¼¸å…¥æ¡†å³æ™‚é©—è­‰
    document.getElementById('inputBox').addEventListener('input', function() {
      const value = this.value.replace(/\D/g, '');
      if (this.value !== value) this.value = value;
      if (value.length > 14) this.value = value.substring(0, 14);
    });
    
    // Enter éµæäº¤
    document.getElementById('inputBox').addEventListener('keypress', function(e) {
      if (e.key === 'Enter') submitQuery();
    });
  </script>
</body>
</html>
